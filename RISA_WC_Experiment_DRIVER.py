"""
This is the driver script for running weathering crust radiative transfer experiments
for the RISA project.

This requires imports from the BiOSNICAR_GO_PY repository and must therefore be run in
the BiOSNICAR_GO_PY directory. This can be downloaded from www.github.com/jmcook1186/BiOSNICAR_GO_PY/
This script along with RISA_WC_Experiment_FUNCS.py must then be copied into the 
top level directory and run in the BioSNICAR_py Python 3 environment.

This driver script calls functions stored in RISA_WC_Experiment_FUNCS.py.
There are three functions which themselves call local functions or functions from BioSNICAR_GO_PY.
These three are:

find_best_params(): This is used to do multiple runs of SNICAR and find the parameter set that 
best simulates a given field-measured spectrum

match_field_spectrum(): for a given set of input params this function plots measured vs simulated spectra

isolate_biological_effect(): calculate the proportion of albedo change attributed to biological or physical 
processes by spectral differencing.

All calls to SNICAR assume cosSZA= 0.6, underlying surface has BBA = 0.1, Picard (2016) ice refractive
index is used, grains are spherical.

"""

import numpy as np
from RISA_WC_Experiment_FUNCS import match_field_spectra, isolate_biological_effect, find_best_params

# set path to field spectral database
field_data_fname = '/home/joe/Code/Remote_Ice_Surface_Analyser/Training_Data/HCRF_master_16171819.csv'

# set parallel arrays of filenames plus density, radius, thickness, model algal concn (ppb)
# and measured algal concn (cells/mL) for each sample to plot.
# These value are likely generated by repeated calls to find_best_params()
fnames= ['2016_WI_8','14_7_SB6','14_7_SB9','14_7_SB1','21_7_SB2','14_7_SB2', '22_7_SB3', 'RAIN']
rho = [[550,550],[650,650],[800,800],[850,850],[750,750],[800,800],[800,800],[900,900]]
rds = [[550,550],[650,650],[850,850],[850,850],[800,800],[800,800],[750,750],[900,900]]
dz = [[0.001,0.3],[0.001,0.09],[0.001,0.03],[0.001,0.03],[0.001,0.02],[0.001,0.06],[0.001,0.05],[0.001,0.03]]
alg = [[0,0],[0,0],[20000,0],[30000,0],[45000,0],[3000,0],[8000,0],[0,0]]  
measured_cells=[0,0,21875,30312,44861,3062,6687,0]

# provide list of samples to include as examples of each surface type
CIsites = ['21_7_S4', '13_7_SB3', '14_7_SB6', '15_7_S4', '15_7_SB1', 
            '15_7_SB5', '21_7_S2', '21_7_SB3', '22_7_S2',
            '22_7_S4', '23_7_SB1', '23_7_SB2', '23_7_S4', 'WI_3',
            'WI_8', 'WI_10', 'WI_11']

DISPsites = ['DISP1','DISP2','DISP3','DISP4','DISP5','DISP6',
            'DISP7','DISP8', 'DISP9','DISP10','DISP11','DISP12',
            'DISP13','DISP14', '27_7_16_DISP1','27_7_16_DISP3']

LAsites = ['13_7_SB1','13_7_SB3','14_7_SB2','14_7_SB3','22_7_SB3']

HAsites = ['13_7_SB2','14_7_SB1','14_7_SB5','14_7_SB9',
            '14_7_SB10','15_7_SB3','20_7_SB1','21_7_SB2','21_7_SB4',
            '22_7_SB2','22_7_SB5','23_7_SB4', '23_7_SB5']

# path to save figures
savepath = '/home/joe/Code/Remote_Ice_Surface_Analyser/Manuscript/Figures/'


#################
# CALL FUNCTIONS
#################

# 1) if aiming to find best param set for simulating a specific field spectrum,
# provide sample ID or one of "CImean", "LAmean" or "HAmean" to find_best_params().
# If no LAPs, set clean=True
#best_params, best_error, best_albedo = find_best_params(LAspec.mean(axis=1),clean=False)

# 2) once best param set has been determined using find_best_params for 8 spectra and
# they are collatd into parallel arrays, pass them to this function to display
# them in a multipanel figure
match_field_spectra(field_data_fname, fnames, rho, rds, dz, alg, measured_cells,\
     CIsites, LAsites, HAsites, savepath)

# 3) to estimate biological and physical contributions to albedo reduction
delAbio, delAphys = isolate_biological_effect(field_data_fname,CIsites,LAsites,HAsites, savepath)
print("Change in BBA due to glacier algae = {}".format(delAbio))
print("Change in BBA due to weathering crust degradation = {}".format(delAphys))